/**
 * tinymce plugin
 * Created by jerry on 16/8/5.
 */
tinymce.PluginManager.add('uploadimage', function (editor) {
    function selectLocalImages() {
        var dom = editor.dom;
        var input_f = $('<input type="file" name="file" accept="image/jpg,image/jpeg,image/png,image/gif" multiple="multiple">');
        var form = $("<form id='uploadForm'/>",
            {
                action: editor.settings.upload_image_url, //设置上传图片的路由，配置在初始化时
                style: 'display:none',
                method: 'post',
                enctype: 'multipart/form-data'
            }
        );

        input_f.on('click', function () {
            form.append(input_f);
        });

        input_f.click();

        input_f.change(function () {
            var formData = new FormData(form[0]);
            $.ajax({
                type: "POST",
                url: editor.settings.upload_image_url,
                data: formData,// 你的formid
                async: false,
                cache: false,
                contentType: false,
                processData: false,
                success: function (data) {
                    if (data && data.result.filePath) {
                        editor.focus();
                        editor.selection.setContent(dom.createHTML('img', { src: data.result.filePath, alt: data.result.name, title: data.result.name }));
                    }
                }
            });
        });
    }

    editor.addCommand("mceUploadImageEditor", selectLocalImages);

    editor.addButton('uploadimage', {
        icon: 'image',
        tooltip: '上传图片',
        onclick: selectLocalImages
    });

    editor.addMenuItem('uploadimage', {
        icon: 'image',
        text: '上传图片',
        context: 'tools',
        onclick: selectLocalImages
    });
});